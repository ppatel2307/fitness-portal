// Prisma Schema for Fitness Training Portal
// Database: PostgreSQL
// Features: Role-based auth, workout plans, nutrition tracking, check-ins

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTH & USERS ====================

enum Role {
  ADMIN
  CLIENT
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  role         Role     @default(CLIENT)
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  clientProfile    ClientProfile?
  refreshTokens    RefreshToken[]
  workoutPlans     WorkoutPlan[]
  nutritionTarget  NutritionTarget?
  foodLogs         FoodLog[]
  weightLogs       WeightLog[]
  checkIns         CheckIn[]
  announcements    Announcement[]   @relation("AnnouncementRecipient")

  @@index([email])
  @@index([role])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model ClientProfile {
  id             String   @id @default(uuid())
  userId         String   @unique
  height         Float?   // in cm
  goal           String?
  notes          String?
  profilePhotoUrl String?
  bannerPhotoUrl  String?
  timezone       String?  @default("UTC")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== WORKOUT PLANS ====================

model WorkoutPlan {
  id        String    @id @default(uuid())
  clientId  String
  title     String
  weekStart DateTime?
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  client      User         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  workoutDays WorkoutDay[]

  @@index([clientId])
}

model WorkoutDay {
  id            String   @id @default(uuid())
  workoutPlanId String
  dayOfWeek     Int      // 0 = Sunday, 1 = Monday, etc.
  title         String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  workoutPlan WorkoutPlan @relation(fields: [workoutPlanId], references: [id], onDelete: Cascade)
  exercises   Exercise[]

  @@index([workoutPlanId])
}

model Exercise {
  id           String   @id @default(uuid())
  workoutDayId String
  name         String
  sets         Int
  reps         String   // Can be "8-12" or "AMRAP" etc.
  rpe          Float?   // Rate of Perceived Exertion
  weight       String?  // Notes about weight
  restSeconds  Int?
  notes        String?
  videoUrl     String?
  orderIndex   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workoutDay WorkoutDay @relation(fields: [workoutDayId], references: [id], onDelete: Cascade)

  @@index([workoutDayId])
}

model WorkoutCompletion {
  id           String   @id @default(uuid())
  clientId     String
  workoutDayId String
  completedAt  DateTime @default(now())
  comment      String?

  @@unique([clientId, workoutDayId, completedAt])
  @@index([clientId])
}

// ==================== NUTRITION ====================

model NutritionTarget {
  id          String   @id @default(uuid())
  clientId    String   @unique
  calories    Int
  protein     Int      // grams
  carbs       Int      // grams
  fat         Int      // grams
  waterLiters Float    @default(2.5)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client User @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model FoodLog {
  id        String   @id @default(uuid())
  clientId  String
  date      DateTime @db.Date
  mealName  String
  calories  Int
  protein   Int
  carbs     Int
  fat       Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client User @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId, date])
}

// ==================== PROGRESS TRACKING ====================

model WeightLog {
  id        String   @id @default(uuid())
  clientId  String
  date      DateTime @db.Date
  weight    Float    // in kg
  note      String?
  photoUrl  String?  // Progress photo placeholder
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client User @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, date])
  @@index([clientId, date])
}

// ==================== COMMUNICATION ====================

enum AudienceType {
  ALL
  SPECIFIC
}

model Announcement {
  id           String       @id @default(uuid())
  title        String
  body         String
  audienceType AudienceType @default(ALL)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  recipients User[] @relation("AnnouncementRecipient")

  @@index([createdAt])
}

// ==================== CHECK-INS ====================

model CheckIn {
  id        String   @id @default(uuid())
  clientId  String
  weekOf    DateTime @db.Date
  energy    Int      // 1-10
  sleepHours Float
  stress    Int      // 1-10
  adherence Int      // 1-10 (workout/nutrition adherence)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client User @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, weekOf])
  @@index([clientId])
}

// ==================== CONTENT LIBRARY ====================

enum ResourceCategory {
  NUTRITION
  FORM
  MINDSET
  OTHER
}

model Resource {
  id          String           @id @default(uuid())
  title       String
  description String?
  url         String
  category    ResourceCategory @default(OTHER)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([category])
}
